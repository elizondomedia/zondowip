<script>
    const autoGif = document.getElementById("autoGifOverlay");
    const colorGifOverlay = document.getElementById("colorGifOverlay");
    const freqDisplay = document.getElementById("freqDisplay");
    const freqBox = document.getElementById("freqBox");
    const bgSelector = document.getElementById("bgSelector");

    let autoMode = true; // Default is Auto Mode

    const frequencyMapping = {
      144: "LIGHTBLUE_144.GIF",
      244: "LIGHTGREEN_244.GIF",
      350: "PINK_350.GIF",
      384: "TEAL_384.GIF",
      396: "BURGUNDY_396.GIF",
      400: "DARKGREEN_400.GIF",
      432: "DARKPURPLE_432.GIF",
      480: "DARKBLUE_480.GIF",
      528: "YELLOW_528.GIF",
      540: "TURQUOISE_540.GIF",
      700: "ORANGE_700.GIF",
      768: "LIGHTPURPLE_768.GIF",
      852: "SILVER_852.GIF",
      963: "GOLD_963.GIF"
    };

    function startMic() {
      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        const audioContext = new AudioContext();
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 8192;
        const micSource = audioContext.createMediaStreamSource(stream);
        micSource.connect(analyser);

        function analyzeAudio() {
          const dataArray = new Float32Array(analyser.frequencyBinCount);
          analyser.getFloatFrequencyData(dataArray);
          const maxIndex = dataArray.indexOf(Math.max(...dataArray));
          const frequency = (maxIndex * audioContext.sampleRate) / analyser.fftSize;
          freqDisplay.textContent = `${Math.round(frequency)} Hz`;

          if (autoMode) {
            let detectedFreq = Object.keys(frequencyMapping).find(
              f => Math.abs(frequency - f) <= 20
            );

            if (detectedFreq) {
              colorGifOverlay.src = `https://raw.githubusercontent.com/elizondomedia/zondowip/main/${frequencyMapping[detectedFreq]}`;
              colorGifOverlay.style.opacity = 1;
              colorGifOverlay.style.display = "block";
            } else {
              colorGifOverlay.style.opacity = 0;
              colorGifOverlay.style.display = "none";
            }
          }

          requestAnimationFrame(analyzeAudio);
        }

        analyzeAudio();
      }).catch(error => console.error("Mic Access Denied", error));
    }

    function toggleFreqGuide() {
      if (freqBox.classList.contains("visible")) {
        freqBox.style.maxHeight = "0px";
        freqBox.style.opacity = "0";
        freqBox.style.padding = "0";
        freqBox.classList.remove("visible");
      } else {
        freqBox.style.maxHeight = "900px";
        freqBox.style.opacity = "1";
        freqBox.style.padding = "10px";
        freqBox.classList.add("visible");
      }
    }

    bgSelector.addEventListener("change", () => {
      autoMode = bgSelector.value === "AUTO";

      if (!autoMode) {
        colorGifOverlay.src = `https://raw.githubusercontent.com/elizondomedia/zondowip/main/${bgSelector.value}`;
        colorGifOverlay.style.opacity = 1;
        colorGifOverlay.style.display = "block";
      }
    });

    document.getElementById("micButton").addEventListener("click", startMic);
    document.getElementById("freqToggle").addEventListener("click", toggleFreqGuide);
</script>
