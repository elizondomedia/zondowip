<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zondo Visualizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      overflow: hidden;
      height: 100%;
      width: 100%;
    }
    #visualizer-container {
      position: relative;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }
    #visualizer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
    }
    #controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 2;
      display: flex;
      align-items: center;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 5px;
      color: #fff;
      font-family: sans-serif;
    }
    #controls label {
      margin-right: 5px;
    }
    #controls input, #controls select {
      margin-right: 10px;
    }
    #mic-status {
      margin-left: 10px;
      font-weight: bold;
    }
    #fullscreen-btn {
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div id="visualizer-container">
    <img id="visualizer" src="WHITE_000.GIF" alt="Visualizer Animation">
    <div id="controls">
      <label for="frequencyInput">Frequency:</label>
      <input type="number" id="frequencyInput" min="144" max="963" step="1">
      <button id="setFrequencyBtn">Set Frequency</button>
      <label for="colorSelect">Color:</label>
      <select id="colorSelect">
        <option value="LIGHTBLUE_144.GIF">Light Blue</option>
        <option value="LIGHTGREEN_244.GIF">Light Green</option>
        <option value="PINK_350.GIF">Pink</option>
        <option value="TEAL_384.GIF">Teal</option>
        <option value="BURGUNDY_396.GIF">Burgundy</option>
        <option value="DARKGREEN_400.GIF">Dark Green</option>
        <option value="DARKPURPLE_432.GIF">Dark Purple</option>
        <option value="DARKBLUE_480.GIF">Dark Blue</option>
        <option value="YELLOW_528.GIF">Yellow</option>
        <option value="TURQUOISE_540.GIF">Turquoise</option>
        <option value="ORANGE_700.GIF">Orange</option>
        <option value="LIGHTPURPLE_768.GIF">Light Purple</option>
        <option value="SILVER_852.GIF">Silver</option>
        <option value="GOLD_962.GIF">Gold</option>
        <option value="WHITE_000.GIF" selected>Default</option>
      </select>
      <button id="micButton">Grant Mic Access</button>
      <span id="mic-status">Mic: off</span>
      <button id="fullscreen-btn">Fullscreen</button>
    </div>
  </div>

  <script>
    const visualizer = document.getElementById("visualizer");
    const frequencyInput = document.getElementById("frequencyInput");
    const setFrequencyBtn = document.getElementById("setFrequencyBtn");
    const colorSelect = document.getElementById("colorSelect");
    const micButton = document.getElementById("micButton");
    const micStatus = document.getElementById("mic-status");
    const fullscreenBtn = document.getElementById("fullscreen-btn");

    let audioContext, analyser, micStream, animationFrameId;

    function getFrequencyGif(frequency) {
      const gifs = {
        144: "LIGHTBLUE_144.GIF",
        244: "LIGHTGREEN_244.GIF",
        350: "PINK_350.GIF",
        384: "TEAL_384.GIF",
        396: "BURGUNDY_396.GIF",
        400: "DARKGREEN_400.GIF",
        432: "DARKPURPLE_432.GIF",
        480: "DARKBLUE_480.GIF",
        528: "YELLOW_528.GIF",
        540: "TURQUOISE_540.GIF",
        700: "ORANGE_700.GIF",
        768: "LIGHTPURPLE_768.GIF",
        852: "SILVER_852.GIF",
        963: "GOLD_962.GIF",
        default: "WHITE_000.GIF"
      };
      return gifs[frequency] || gifs["default"];
    }

    // Handle manual frequency input
    setFrequencyBtn.addEventListener("click", () => {
      const frequency = parseInt(frequencyInput.value);
      if (!isNaN(frequency)) {
        visualizer.src = getFrequencyGif(frequency);
      }
    });

    // Request microphone access
    micButton.addEventListener("click", () => {
      if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then((stream) => {
            micStatus.textContent = "Mic: ON";
            micStatus.style.color = "lime";
            micButton.disabled = true;

            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            micStream = audioContext.createMediaStreamSource(stream);
            micStream.connect(analyser);

            processMicAudio();
          })
          .catch((error) => {
            console.error("Mic Access Denied:", error);
            micStatus.textContent = "Mic: Denied";
            micStatus.style.color = "red";
          });
      } else {
        alert("Microphone access is not supported in this browser.");
      }
    });

    // Process audio input safely
    function processMicAudio() {
      const dataArray = new Uint8Array(analyser.frequencyBinCount);

      function analyzeFrequency() {
        analyser.getByteFrequencyData(dataArray);
        if (dataArray.length === 0) return; // Prevents reduce() on empty array error

        let avgFrequency = dataArray.reduce((sum, val) => sum + val, 0) / dataArray.length || 144;
        let closestFrequency = Object.keys(getFrequencyGif()).map(Number).reduce((prev, curr) =>
          Math.abs(curr - avgFrequency) < Math.abs(prev - avgFrequency) ? curr : prev
        );

        visualizer.src = getFrequencyGif(closestFrequency);
        animationFrameId = requestAnimationFrame(analyzeFrequency);
      }
      analyzeFrequency();
    }

    // Fullscreen functionality
    fullscreenBtn.addEventListener("click", () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    });

    // Update GIF when color selection changes
    colorSelect.addEventListener("change", () => {
      visualizer.src = colorSelect.value;
    });
  </script>
</body>
</html>
